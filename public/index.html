
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Taste Vector Collector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 p-6 text-gray-900">
  <div class="max-w-xl mx-auto">
    <h1 class="text-2xl font-bold text-center mb-4">Rate the Taste</h1>
    <p class="text-center mb-6">Help us map the flavor of Indian dishes</p>

    <div id="nameInputSection" class="mb-6">
      <label for="username" class="block font-semibold mb-1">Enter Your Name</label>
      <input type="text" id="username" name="username" required class="w-full p-2 border border-gray-300 rounded mb-2" placeholder="e.g. Rohit">
      <button id="startButton" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">Start Rating</button>
    </div>

    <div id="mainFormSection" class="hidden">
      <form id="tasteForm" class="space-y-4">
        <div>
          <label for="dish">Dish</label>
          <select id="dish" required class="w-full p-2 border border-gray-300 rounded">
            <option value="">Select a dish...</option>
          </select>
        </div>

        <div id="currentDish" class="text-lg font-medium text-center text-blue-700 mb-2"></div>

        <div id="sliders" class="space-y-2"></div>

        <div>
          <label for="notes">Notes (optional)</label>
          <textarea id="notes" class="w-full p-2 border border-gray-300 rounded" rows="2"></textarea>
        </div>

        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">Submit</button>
      </form>

      <p id="status" class="text-green-600 mt-4 text-center hidden">Submission saved!</p>
      <button id="switchUserBtn" class="mt-4 text-sm text-red-500 underline w-full">Switch User</button>
    </div>
  </div>

  <script>
    const dishes = [
      "Aamras", "Dhokla", "Palak Paneer", "Masala Dosa", "Pani Puri", "Rasam", "Gajar Halwa",
      "Coconut Chutney", "Kadhi", "Vegetable Pulao", "Cucumber Raita", "Chana Masala", "Thepla",
      "Sabudana Khichdi", "Moong Dal Halwa", "Paneer Butter Masala", "Vegetable Biryani",
      "Besan Ladoo", "Aloo Paratha", "Rajma Chawal"
    ];

    const tastes = ["Sweet", "Sour", "Salty", "Bitter", "Umami", "Spicy"];
    const ratedDishes = new Set(JSON.parse(localStorage.getItem("ratedDishes") || "[]"));
    let username = localStorage.getItem("tasteCollectorUser") || "";

    const dishSelect = document.getElementById("dish");
    const currentDishDisplay = document.getElementById("currentDish");
    const mainFormSection = document.getElementById("mainFormSection");
    const nameInputSection = document.getElementById("nameInputSection");

    if (username) {
      nameInputSection.classList.add("hidden");
      mainFormSection.classList.remove("hidden");
      updateProgressBar();
      populateDishOptions();
    }

    document.getElementById("startButton").addEventListener("click", () => {
      const inputName = document.getElementById("username").value.trim();
      if (inputName) {
        username = inputName;
        localStorage.setItem("tasteCollectorUser", username);
        nameInputSection.classList.add("hidden");
        mainFormSection.classList.remove("hidden");
        updateProgressBar();
        populateDishOptions();
      }
    });

    function populateDishOptions() {
      dishSelect.innerHTML = '<option value="">Select a dish...</option>';
      dishes.filter(dish => !ratedDishes.has(dish)).forEach(dish => {
        const option = document.createElement("option");
        option.value = dish;
        option.textContent = dish;
        dishSelect.appendChild(option);
      });
    }

    dishSelect.addEventListener("change", () => {
      currentDishDisplay.textContent = dishSelect.value ? `Currently rating: ${dishSelect.value}` : "";
    });

    const slidersContainer = document.getElementById("sliders");
    tastes.forEach((taste, i) => {
      const wrapper = document.createElement("div");
      wrapper.innerHTML = `
        <label for="taste${i}" class="block font-semibold mb-1">${taste}</label>
        <input type="range" id="taste${i}" name="taste${i}" min="0" max="10" value="0" class="w-full">
      `;
      slidersContainer.appendChild(wrapper);
    });

    function updateProgressBar() {
      const total = dishes.length;
      const completed = ratedDishes.size;
      const percent = Math.round((completed / total) * 100);
      document.getElementById("progressText")?.textContent = `${completed} of ${total} dishes rated`;
      document.getElementById("progressBar")?.style.setProperty("width", `${percent}%`);
    }

    document.getElementById("tasteForm").addEventListener("submit", async e => {
      e.preventDefault();

      const taste_vector = tastes.map((_, i) => parseInt(document.getElementById(`taste${i}`).value));
      const dish = dishSelect.value;
      const notes = document.getElementById("notes").value;

      const submission = {
        user: username,
        dish,
        taste_vector,
        notes,
        timestamp: new Date().toISOString()
      };

      try {
        const response = await fetch("https://taste-collector-backend.onrender.com/submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(submission)
        });

        if (!response.ok) throw new Error("Submission failed");
        console.log("✅ Submission saved to backend!");
      } catch (err) {
        console.error("❌ Failed to submit:", err);
      }

      ratedDishes.add(dish);
      localStorage.setItem("ratedDishes", JSON.stringify([...ratedDishes]));
      updateProgressBar();
      populateDishOptions();
      currentDishDisplay.textContent = "";

      document.getElementById("status").classList.remove("hidden");
      setTimeout(() => document.getElementById("status").classList.add("hidden"), 3000);
      e.target.reset();
    });

    document.getElementById("switchUserBtn").addEventListener("click", () => {
      localStorage.removeItem("tasteCollectorUser");
      window.location.reload();
    });
  </script>
</body>
</html>
